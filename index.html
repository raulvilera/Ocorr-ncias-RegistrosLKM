<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 - Cadastro de Ocorrências</title>
    <!-- Biblioteca para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: rgba(0, 31, 63, 0.9);
            backdrop-filter: blur(5px);
        }

        .login-form {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #001f3f;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #001f3f;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background-color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.2);
            outline: none;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .login-btn:hover {
            background: linear-gradient(to right, #2a5298, #3a6bd1);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .app-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #001f3f 0%, #003366 100%);
            color: white;
            padding: 18px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .content {
            flex: 1;
            padding: 30px;
        }

        /* Estilos específicos para a interface de gestão */
        .gestao-container {
            display: none;
        }

        .form-title {
            background: linear-gradient(135deg, #001f3f 0%, #003366 100%);
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-size: 20px;
        }

        .gestao-form {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 20px;
        }

        .form-field {
            flex: 1;
            min-width: 250px;
        }

        .form-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #001f3f;
        }

        .form-field input, .form-field select, .form-field textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background-color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-field input:focus, .form-field select:focus, .form-field textarea:focus {
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.2);
            outline: none;
        }

        .form-field textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Campos com tamanho ajustável */
        .size-to-content {
            width: auto !important;
            min-width: 100px;
            max-width: 100%;
        }

        /* Estilização especial para campos de data */
        input[type="date"], input[type="time"] {
            position: relative;
            padding-right: 40px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
            opacity: 0;
            z-index: 1;
        }

        input[type="date"]::after,
        input[type="time"]::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
        }

        input[type="date"]::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23001f3f'%3E%3Cpath d='M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z'/%3E%3C/svg%3E");
        }

        input[type="time"]::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23001f3f'%3E%3Cpath d='M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z'/%3E%3C/svg%3E");
        }

        .submit-btn {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .submit-btn:hover {
            background: linear-gradient(to right, #2a5298, #3a6bd1);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .success-message {
            background: linear-gradient(to right, #4CAF50, #2E7D32);
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: bold;
            margin-top: 25px;
            display: none;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Estilos específicos para a interface do professor */
        .professor-container {
            display: none;
        }

        .occurrence-form {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .form-section h3 {
            margin-bottom: 20px;
            color: #001f3f;
            font-size: 18px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2a5298;
            display: inline-block;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .checkbox-item input {
            margin-right: 5px;
            width: 18px;
            height: 18px;
        }

        .hidden {
            display: none;
        }

        /* Estilos para autocomplete */
        .autocomplete {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .autocomplete-items {
            position: absolute;
            border: 2px solid #d4d4d4;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-items div {
            padding: 12px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
            transition: background-color 0.2s;
        }

        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            background-color: #2a5298 !important;
            color: #ffffff;
        }

        /* Estilos para o modal de seleção de alunos */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: none;
            width: 80%;
            max-width: 700px;
            border-radius: 12px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #000;
        }

        .student-list {
            margin-top: 20px;
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .student-item:hover {
            background-color: #f5f5f5;
        }

        .selected-students {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .selected-student {
            display: inline-block;
            background: linear-gradient(to right, #2a5298, #3a6bd1);
            color: white;
            padding: 8px 15px;
            margin: 8px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .download-btn {
            background: linear-gradient(to right, #4CAF50, #2E7D32);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 15px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .download-btn:hover {
            background: linear-gradient(to right, #2E7D32, #1B5E20);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #001f3f;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .login-form {
                width: 90%;
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-field {
                min-width: 100%;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                justify-content: center;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }

            .size-to-content {
                width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>2025 - Cadastro de Ocorrências</h2>
            <div class="form-group">
                <label for="email">E-mail:</label>
                <input type="email" id="email" placeholder="Digite seu e-mail" class="size-to-content">
            </div>
            <div class="form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" placeholder="Digite sua senha" class="size-to-content">
            </div>
            <button class="login-btn" onclick="login()">Entrar</button>
        </div>
    </div>

    <!-- Container principal da aplicação -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <h1>2025 - Cadastro de Ocorrências</h1>
            <div class="user-info">
                <span id="userName">Usuário</span>
                <button class="logout-btn" onclick="logout()">Sair</button>
                <button class="download-btn" id="downloadPdfBtn" style="display:none;" onclick="generatePDF()">Baixar PDF</button>
            </div>
        </div>

        <!-- Interface de Gestão -->
        <div class="content gestao-container" id="gestaoContainer">
            <div class="form-title">
                CADASTRO DE OCORRÊNCIAS - GESTÃO
            </div>
            <div class="gestao-form">
                <div class="form-row">
                    <div class="form-field">
                        <label for="aluno">ALUNO:</label>
                        <div class="autocomplete">
                            <input type="text" id="aluno" oninput="autocompleteAluno(this.value)" class="size-to-content">
                            <div id="autocomplete-list" class="autocomplete-items"></div>
                        </div>
                    </div>
                    <div class="form-field">
                        <label for="serie">SÉRIE/TURMA:</label>
                        <input type="text" id="serie" readonly class="size-to-content">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="professor">PROFESSOR:</label>
                        <input type="text" id="professor" class="size-to-content">
                    </div>
                    <div class="form-field">
                        <label for="ra">RA:</label>
                        <input type="text" id="ra" readonly class="size-to-content">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="disciplina">DISCIPLINA:</label>
                        <input type="text" id="disciplina" class="size-to-content">
                    </div>
                    <div class="form-field">
                        <label for="classificacao">CLASSIFICAÇÃO:</label>
                        <select id="classificacao" onchange="toggleSuspensionField()" class="size-to-content">
                            <option value="">Selecione</option>
                            <option value="OCORRÊNCIA">OCORRÊNCIA</option>
                            <option value="SUSPENSÃO">SUSPENSÃO</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="suspensionField" style="display: none;">
                    <div class="form-field">
                        <label for="dataRetorno">DATA DE RETORNO:</label>
                        <input type="date" id="dataRetorno" class="size-to-content">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="descricao">DESCRIÇÃO:</label>
                        <textarea id="descricao" class="size-to-content"></textarea>
                    </div>
                </div>
                <button class="submit-btn" onclick="cadastrarOcorrencia()">Cadastrar Ocorrência</button>
                
                <div class="success-message" id="successMessage">
                    OCORRÊNCIA REGISTRADA COM SUCESSO
                </div>
            </div>
        </div>

        <!-- Interface do Professor -->
        <div class="content professor-container" id="professorContainer">
            <div class="form-title">
                REGISTRO DE OCORRÊNCIAS - PROFESSOR
            </div>
            <div class="occurrence-form">
                <div class="form-section">
                    <h3>1. IDENTIFICAÇÃO DA OCORRÊNCIA</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="professorNome">NOME DO PROFESSOR:</label>
                            <select id="professorNome" class="size-to-content">
                                <option value="">Selecione o professor</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="professorTurma">TURMA:</label>
                            <select id="professorTurma" onchange="carregarAlunosTurma()" class="size-to-content">
                                <option value="">Selecione a turma</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="alunoOcorrencia">ALUNO(S) ENVOLVIDO(S):</label>
                            <input type="text" id="alunoOcorrencia" readonly onclick="abrirModalAlunos()" class="size-to-content">
                            <div id="selectedStudents" class="selected-students"></div>
                        </div>
                        <div class="form-field">
                            <label for="dataOcorrencia">DATA DA OCORRÊNCIA:</label>
                            <input type="date" id="dataOcorrencia" class="size-to-content">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>2. TIPO DE IRREGULARIDADE</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="irregularidade1" name="irregularidades" value="Indisciplina">
                            <label for="irregularidade1">Indisciplina</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="irregularidade2" name="irregularidades" value="Uso de celular">
                            <label for="irregularidade2">Uso de celular</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="irregularidade3" name="irregularidades" value="Conversa paralela">
                            <label for="irregularidade3">Conversa paralela</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="irregularidade4" name="irregularidades" value="Agressão verbal">
                            <label for="irregularidade4">Agressão verbal</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="irregularidade5" name="irregularidades" value="Agressão física">
                            <label for="irregularidade5">Agressão física</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="irregularidade6" name="irregularidades" value="Danos ao patrimônio">
                            <label for="irregularidade6">Danos ao patrimônio</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="irregularidade7" name="irregularidades" value="Outros">
                            <label for="irregularidade7">Outros</label>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>3. DESCRIÇÃO DA OCORRÊNCIA</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <textarea id="descricaoOcorrencia" placeholder="Descreva detalhadamente a ocorrência..." class="size-to-content"></textarea>
                        </div>
                    </div>
                </div>

                <button class="submit-btn" onclick="registrarOcorrenciaProfessor()">Registrar Ocorrência</button>
                
                <div class="success-message" id="professorSuccessMessage">
                    OCORRÊNCIA REGISTRADA COM SUCESSO
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para seleção de alunos -->
    <div id="alunosModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalAlunos()">&times;</span>
            <h3>Selecione os alunos envolvidos</h3>
            <div id="studentList" class="student-list">
                <!-- Lista de alunos será preenchida aqui -->
            </div>
            <button class="submit-btn" style="margin-top: 15px;" onclick="confirmarAlunos()">Confirmar</button>
        </div>
    </div>

    <script>
        // URLs do Google Apps Script Web App
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5w7k1M5zU8Q2UJd1RkZQ7Q4V5X4Q3Q2Q1Q0Q0Q0/exec';
        const SPREADSHEET_ID = '1u7qMsMHkZT47OZdar5qvshQDRA8XJrLgDjAZVOViAio';
        const SHEET_NAME = 'OCORRENCIASDOSPROFESSORES';

        // Variáveis globais
        let alunos = [];
        let professores = [];
        let turmas = [];
        let alunosSelecionados = [];
        let currentAlunoData = null;
        let alunosDaTurmaAtual = [];

        // Funções de mapeamento
        function _getClassRanges() {
            return {
                "6° ANO A MANHA": "C3:C46",
                "6° ANO B MANHA": "H3:H46",
                "6° ANO C MANHA": "M3:M46",
                "6° ANO D MANHA": "R3:R46",
                "6° ANO E TARDE": "W3:W46",
                "6° ANO F TARDE": "AB3:AB46",
                "7° ANO A TARDE": "AG3:AG46",
                "7° ANO B TARDE": "AL3:AL46",
                "7° ANO C TARDE": "AQ3:AQ46",
                "7° ANO D TARDE": "AV3:AV46",
                "7° ANO E TARDE": "BA3:BA46",
                "7° ANO F TARDE": "BF3:BF46",
                "8° ANO A TARDE": "BK3:BK46",
                "8° ANO B TARDE": "BP3:BP46",
                "8° ANO C TARDE": "BU3:BU46",
                "8° ANO D TARDE": "BZ3:BZ46",
                "9° ANO A TARDE": "CE3:CE46",
                "9° ANO B TARDE": "CJ3:CJ46",
                "9° ANO C TARDE": "CO3:CO46",
                "9° ANO D TARDE": "CT3:CT46",
                "1ª SERIE A MANHA": "CY3:CY46",
                "1ª SERIE B MANHA": "DD3:DD46",
                "1ª SERIE C MANHA": "DI3:DI46",
                "1ª SERIE D MANHA": "DN3:DN46",
                "1ª SERIE E MANHA": "DS3:DS46",
                "1ª SERIE F MANHA": "DX3:DX46",
                "1ª SERIE G TARDE": "EC3:EC46",
                "1ª SERIE H NOITE": "EH3:EH46",
                "1ª SERIE I NOITE": "EM3:EM46",
                "2ª SERIE A MANHA": "ER3:ER46",
                "2ª SERIE B MANHA": "EW3:EW46",
                "2ª SERIE C MANHA": "FB3:FB46",
                "2ª SERIE D MANHA": "FG3:FG46",
                "2ª SERIE E MANHA": "FL3:FL46",
                "2ª SERIE F NOITE": "FQ3:FQ46",
                "2ª SERIE G NOITE": "FV3:FV46",
                "2ª SERIE H NOITE": "GA3:GA46",
                "3ª SERIE A MANHA": "GK3:GK46",
                "3ª SERIE B MANHA": "GP3:GP46",
                "3ª SERIE C MANHA": "GU3:GU46",
                "3ª SERIE D NOITE": "GZ3:GZ46",
                "3ª SERIE E NOITE": "HE3:HE46",
                "3ª SERIE F NOITE": "HJ3:HJ46"
            };
        }

        function getAllTeachers() {
            return [
                "ALEX LUTH PEREIRA MARANHAO",
                "ALEXSANDRA PAULA VARELLA DE SOUZA",
                "ALISON VASCONCELOS BESERRA",
                "AMAURI TEODORO DE OLIVEIRA",
                "ANA PAULA DOS SANTOS",
                "ANDREIA DOS SANTOS FREITAS",
                "ANDREIA MADUREIRA REIS",
                "ANTONIO CARLOS DE OLIVEIRA",
                "ANTONIO RAMOS DE ARAUJO",
                "ANTONIO WILTON WANDERLEY CABRAL",
                "AUGUSTO LINO PESSOA NETO",
                "AUREA MARIA DE JESUS MARQUES",
                "CAROLINA PERNOMIAN PARUSSOLOLO",
                "CASSIA OLIVEIRA ANTONIAZI",
                "CLAUDINEIA DE AGUIAR LIMA",
                "DANIEL DE FREITAS ALMEIDA",
                "DANIEL LOPES BARBOSA",
                "DANIELA FERREIRA LIMA",
                "DANIELLE LUCIA BATISTA DE ALMEIDA",
                "EDIANE VIEIRA DA SILVA",
                "EDILEUSA NUNES PEREIRA",
                "EDUARDO HENRIQUE DA FONSECA",
                "ELIANE SANTOS SILVA",
                "ELIAS MONTEIRO DA SILVA",
                "ELISABETE APARECIDA PIRES",
                "ELZA DE FARIA PEREIRA",
                "EMERSON GABLER DE ALMEIDA",
                "EUZELI ARAUJO DE OLIVEIRA",
                "FABIANO AUGUSTO PIEDADE",
                "FABIO CAMILO",
                "FERNANDO JOSE DA SILVA FILHO",
                "FLAVIA CRISTINA APARECIDA BICHLER",
                "FLAVIO CARDOSO FLEURY",
                "FRANCISCA EDIVANIA DE MORAIS COSTA",
                "GABRIELA SERIGHELLI DE MELO",
                "GELSON DE ALMEIDA BATISTA",
                "GENILTON DE OLIVEIRA SILVA",
                "GIANI CRISTINA DO PRADO",
                "INGRYD CAROLINA SUGUIMOTO VIEIRA",
                "IVANILDES DOS SANTOS OSHIKAWA",
                "JANINA DOS PASSOS BRAGA DE ALMEIDA",
                "JOSE APARECIDO DA SILVA",
                "JUAREZ GOMES DE MAGALHAES FILHO",
                "JUREMA SOLEDADE FURINI SANTOS",
                "KATIUSCIA ALVES BOMFIM",
                "LUANA CAROLINE ALVES LIMA",
                "LUANA DE FREITAS SILVA",
                "LUCIANA NOVAIS CORREIA SANTOS",
                "LUCIANO MOREIRA DE AZEVEDO",
                "MARCIEL DA SILVA",
                "MARIA HELENA CUNHA MORO",
                "MARIA QUITÉRIA FERREIRA DOS SANTOS",
                "MARINA DA CONCEICAO FRANCISCO SILVA",
                "MAURICIO DE BARROS SANTOS",
                "MICHELE DE PINHO MORAES",
                "MOISES ANTONIO DE BARROS",
                "PAULA ARMANI VILA",
                "PAULO ROBERTO DA SILVA ITO",
                "PEDRO ZANOTTI FILHO",
                "RAUL PEREIRA VILERA JUNIOR",
                "REGIANE CURTI DE SOUZA OLIVEIRA",
                "REGINA DA SILSA CASTRO",
                "RICARDO AMERICO DA SILVA",
                "ROBERTO SALGADO",
                "RODRIGO VIEIRA",
                "ROSANGELA CAFASSO MOREIRA",
                "ROSIMERY DE SOUZA PESSOA",
                "ROSMARA DA SILSA CARDOSO",
                "SANDRA CRISTINA MACEDO MORAES",
                "SELMA GOMES DA SILSA",
                "SERGIO AGRIPINO VILLA NOVA",
                "SOLANGE ALMEIDA DA SILSA",
                "SUZINEIDE SILSA DE FREITAS",
                "THIAGO FABIANO BRITO",
                "TITTO AUGUSTO NASCIMENTO SILSA",
                "VANDERSON HYPPOLITO",
                "VANESSA IVETE GOMES DOS SANTOS",
                "VANIA PENHA DE BARROS",
                "VIVIANE LEAL CAMERA DE MORAES",
                "WILSON RODRIGUES MOTA"
            ];
        }

        // Função para ajustar o tamanho dos campos conforme o conteúdo
        function adjustFieldSizes() {
            const fields = document.querySelectorAll('.size-to-content');
            fields.forEach(field => {
                // Para campos de texto, textarea e select
                if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA' || field.tagName === 'SELECT') {
                    // Criar um elemento temporário para medir o texto
                    const tempElement = document.createElement('div');
                    tempElement.style.position = 'absolute';
                    tempElement.style.left = '-9999px';
                    tempElement.style.whiteSpace = 'nowrap';
                    tempElement.style.font = window.getComputedStyle(field).font;
                    
                    // Obter o valor do campo ou o texto selecionado para selects
                    let text = field.value;
                    if (field.tagName === 'SELECT') {
                        const selectedOption = field.options[field.selectedIndex];
                        text = selectedOption ? selectedOption.text : '';
                    }
                    
                    // Se não houver texto, usar o placeholder
                    if (!text && field.placeholder) {
                        text = field.placeholder;
                    }
                    
                    tempElement.textContent = text || ' ';
                    document.body.appendChild(tempElement);
                    
                    // Ajustar a largura com base no conteúdo
                    const width = Math.max(tempElement.scrollWidth + 30, 100); // Mínimo de 100px
                    field.style.width = `${width}px`;
                    
                    document.body.removeChild(tempElement);
                }
            });
        }

        // Observar mudanças nos campos para ajustar dinamicamente
        function setupFieldObservers() {
            const fields = document.querySelectorAll('.size-to-content');
            fields.forEach(field => {
                field.addEventListener('input', adjustFieldSizes);
                if (field.tagName === 'SELECT') {
                    field.addEventListener('change', adjustFieldSizes);
                }
            });
        }

        // Função de login
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Verificação simples de e-mail e senha
            if (email === 'gestao@escola.com' && password === 'gestao123') {
                showGestaoInterface(email);
                carregarDadosIniciais();
                document.getElementById('downloadPdfBtn').style.display = 'inline-block';
            } else if (email === 'professor@escola.com' && password === 'prof123') {
                showProfessorInterface(email);
                carregarDadosIniciais();
                document.getElementById('downloadPdfBtn').style.display = 'none';
            } else {
                alert('E-mail ou senha incorretos. Tente novamente.');
            }
            
            // Ajustar tamanhos dos campos após login
            setTimeout(adjustFieldSizes, 100);
        }

        // Carregar dados iniciais
        async function carregarDadosIniciais() {
            try {
                // Carregar professores
                professores = getAllTeachers();
                const professorSelect = document.getElementById('professorNome');
                professorSelect.innerHTML = '<option value="">Selecione o professor</option>';
                professores.forEach(professor => {
                    const option = document.createElement('option');
                    option.value = professor;
                    option.textContent = professor;
                    professorSelect.appendChild(option);
                });

                // Carregar turmas
                turmas = Object.keys(_getClassRanges());
                const turmaSelect = document.getElementById('professorTurma');
                turmaSelect.innerHTML = '<option value="">Selecione a turma</option>';
                turmas.forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma;
                    option.textContent = turma;
                    turmaSelect.appendChild(option);
                });

                // Carregar todos os alunos das turmas
                await carregarTodosAlunos();
                
                // Ajustar tamanhos dos campos após carregar dados
                setTimeout(adjustFieldSizes, 100);
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                alert('Erro ao carregar dados. Tente novamente.');
            }
        }

        // Carregar todos os alunos de todas as turmas
        async function carregarTodosAlunos() {
            try {
                alunos = [];
                const classRanges = _getClassRanges();
                const turmasList = Object.keys(classRanges);
                
                for (const turma of turmasList) {
                    const range = classRanges[turma];
                    const response = await fetch(`${SCRIPT_URL}?action=getAlunosByTurma&spreadsheetId=${SPREADSHEET_ID}&range=${range}&turma=${encodeURIComponent(turma)}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.alunos && data.alunos.length > 0) {
                            // Adicionar alunos com informações da turma
                            data.alunos.forEach(alunoNome => {
                                if (alunoNome && alunoNome.trim() !== '') {
                                    alunos.push({
                                        nome: alunoNome.trim(),
                                        turma: turma,
                                        ra: '' // O RA será carregado posteriormente se necessário
                                    });
                                }
                            });
                        }
                    }
                }
                
                console.log('Alunos carregados:', alunos);
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                alert('Erro ao carregar lista de alunos.');
            }
        }

        // Carregar alunos de uma turma específica (para professores)
        async function carregarAlunosTurma() {
            const turmaSelect = document.getElementById('professorTurma');
            const turma = turmaSelect.value;
            
            if (!turma) {
                alunosDaTurmaAtual = [];
                return;
            }
            
            try {
                const classRanges = _getClassRanges();
                const range = classRanges[turma];
                
                if (!range) {
                    alert('Intervalo não encontrado para esta turma.');
                    return;
                }
                
                // Mostrar indicador de carregamento
                turmaSelect.disabled = true;
                turmaSelect.style.backgroundImage = "url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iNyIgc3Ryb2tlPSIjMDAxZjNmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1kYXNoYXJyYXk9IjMyIiBzdHJva2UtZGFzaG9mZnNldD0iMCI+CiAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIGZyb209IjAgMTAgMTAiIHRvPSIzNjAgMTAgMTAiIGR1cj0iMXMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiAvPgo8L2NpcmNsZT4KPC9zdmc+')";
                turmaSelect.style.backgroundRepeat = "no-repeat";
                turmaSelect.style.backgroundPosition = "right 8px center";
                turmaSelect.style.backgroundSize = "20px";
                
                const response = await fetch(`${SCRIPT_URL}?action=getAlunosByTurma&spreadsheetId=${SPREADSHEET_ID}&range=${range}&turma=${encodeURIComponent(turma)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    alunosDaTurmaAtual = data.alunos || [];
                    console.log(`Alunos da turma ${turma}:`, alunosDaTurmaAtual);
                } else {
                    alert('Erro ao carregar alunos da turma.');
                    alunosDaTurmaAtual = [];
                }
            } catch (error) {
                console.error('Erro ao carregar alunos da turma:', error);
                alert('Erro ao carregar alunos da turma.');
                alunosDaTurmaAtual = [];
            } finally {
                // Restaurar estado normal do select
                turmaSelect.disabled = false;
                turmaSelect.style.backgroundImage = "none";
                
                // Ajustar tamanhos dos campos após carregar
                setTimeout(adjustFieldSizes, 100);
            }
        }

        // Função para mostrar interface de gestão
        function showGestaoInterface(email) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('gestaoContainer').style.display = 'block';
            document.getElementById('professorContainer').style.display = 'none';
            document.getElementById('userName').textContent = email;
            
            // Configurar observadores e ajustar tamanhos
            setTimeout(() => {
                setupFieldObservers();
                adjustFieldSizes();
            }, 100);
        }

        // Função para mostrar interface do professor
        function showProfessorInterface(email) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('gestaoContainer').style.display = 'none';
            document.getElementById('professorContainer').style.display = 'block';
            document.getElementById('userName').textContent = email;
            
            // Configurar observadores e ajustar tamanhos
            setTimeout(() => {
                setupFieldObservers();
                adjustFieldSizes();
            }, 100);
        }

        // Função de logout
        function logout() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('downloadPdfBtn').style.display = 'none';
        }

        // Autocomplete para alunos (Gestão)
        function autocompleteAluno(valor) {
            const autocompleteList = document.getElementById("autocomplete-list");
            autocompleteList.innerHTML = "";
            
            if (!valor || valor.length < 2) return;
            
            const filteredAlunos = alunos.filter(aluno => 
                aluno.nome.toLowerCase().includes(valor.toLowerCase())
            );
            
            filteredAlunos.forEach(aluno => {
                const div = document.createElement("div");
                div.innerHTML = `<strong>${aluno.nome}</strong> - ${aluno.turma}`;
                div.addEventListener("click", function() {
                    document.getElementById("aluno").value = aluno.nome;
                    document.getElementById("serie").value = aluno.turma;
                    document.getElementById("ra").value = aluno.ra || "Não disponível";
                    autocompleteList.innerHTML = "";
                    currentAlunoData = aluno;
                    
                    // Ajustar tamanhos após seleção
                    adjustFieldSizes();
                });
                autocompleteList.appendChild(div);
            });
        }

        // Alternar visibilidade do campo de data de retorno para suspensões
        function toggleSuspensionField() {
            const classificacao = document.getElementById('classificacao').value;
            const suspensionField = document.getElementById('suspensionField');
            
            if (classificacao === 'SUSPENSÃO') {
                suspensionField.style.display = 'flex';
            } else {
                suspensionField.style.display = 'none';
            }
            
            // Ajustar tamanhos após mudança
            adjustFieldSizes();
        }

        // Cadastrar ocorrência (Gestão)
        async function cadastrarOcorrencia() {
            const aluno = document.getElementById('aluno').value;
            const serie = document.getElementById('serie').value;
            const professor = document.getElementById('professor').value;
            const ra = document.getElementById('ra').value;
            const disciplina = document.getElementById('disciplina').value;
            const classificacao = document.getElementById('classificacao').value;
            const dataRetorno = document.getElementById('dataRetorno').value;
            const descricao = document.getElementById('descricao').value;
            
            // Validação básica
            if (!aluno || !serie || !professor || !disciplina || !classificacao || !descricao) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            if (classificacao === 'SUSPENSÃO' && !dataRetorno) {
                alert('Para suspensão, é necessário informar a data de retorno.');
                return;
            }
            
            // Dados para enviar para a planilha
            const data = new Date();
            const dataRegistro = `${data.toLocaleDateString()} ${data.toLocaleTimeString()}`;
            
            const dados = {
                aluno: aluno,
                turma: serie,
                professor: professor,
                ra: ra,
                disciplina: disciplina,
                dataRegistro: dataRegistro,
                classificacao: classificacao,
                descricao: descricao,
                dataRetorno: dataRetorno || 'N/A',
                tipoUsuario: 'gestao'
            };
            
            try {
                // Enviar para o Google Apps Script
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'cadastrarOcorrencia',
                        spreadsheetId: SPREADSHEET_ID,
                        sheetName: SHEET_NAME,
                        data: dados
                    })
                });
                
                if (response.ok) {
                    // Mostrar mensagem de sucesso
                    document.getElementById('successMessage').style.display = 'block';
                    
                    // Limpar formulário após 2 segundos
                    setTimeout(() => {
                        document.getElementById('successMessage').style.display = 'none';
                        document.getElementById('aluno').value = '';
                        document.getElementById('serie').value = '';
                        document.getElementById('professor').value = '';
                        document.getElementById('ra').value = '';
                        document.getElementById('disciplina').value = '';
                        document.getElementById('classificacao').value = '';
                        document.getElementById('dataRetorno').value = '';
                        document.getElementById('descricao').value = '';
                        document.getElementById('suspensionField').style.display = 'none';
                        
                        // Ajustar tamanhos após limpar
                        adjustFieldSizes();
                    }, 2000);
                } else {
                    alert('Erro ao registrar ocorrência. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro ao cadastrar ocorrência:', error);
                alert('Erro ao registrar ocorrência. Tente novamente.');
            }
        }

        // Abrir modal de seleção de alunos (Professor)
        function abrirModalAlunos() {
            const turma = document.getElementById('professorTurma').value;
            if (!turma) {
                alert('Por favor, selecione uma turma primeiro.');
                return;
            }
            
            if (alunosDaTurmaAtual.length === 0) {
                alert('Nenhum aluno encontrado para esta turma.');
                return;
            }
            
            const modal = document.getElementById('alunosModal');
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '';
            
            // Adicionar alunos à lista
            alunosDaTurmaAtual.forEach(aluno => {
                if (aluno && aluno.trim() !== '') {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    studentItem.innerHTML = `
                        <input type="checkbox" id="aluno-${aluno.replace(/\s+/g, '-')}" value="${aluno}" 
                            ${alunosSelecionados.includes(aluno) ? 'checked' : ''}>
                        <label for="aluno-${aluno.replace(/\s+/g, '-')}">${aluno}</label>
                    `;
                    studentList.appendChild(studentItem);
                }
            });
            
            modal.style.display = 'block';
        }

        // Fechar modal de alunos
        function fecharModalAlunos() {
            document.getElementById('alunosModal').style.display = 'none';
        }

        // Confirmar seleção de alunos
        function confirmarAlunos() {
            const checkboxes = document.querySelectorAll('#studentList input[type="checkbox"]:checked');
            alunosSelecionados = Array.from(checkboxes).map(cb => cb.value);
            
            // Atualizar campo de alunos selecionados
            const selectedStudentsDiv = document.getElementById('selectedStudents');
            selectedStudentsDiv.innerHTML = '';
            
            if (alunosSelecionados.length === 0) {
                selectedStudentsDiv.innerHTML = '<p>Nenhum aluno selecionado</p>';
                document.getElementById('alunoOcorrencia').value = '';
            } else {
                alunosSelecionados.forEach(aluno => {
                    const span = document.createElement('span');
                    span.className = 'selected-student';
                    span.textContent = aluno;
                    selectedStudentsDiv.appendChild(span);
                });
                document.getElementById('alunoOcorrencia').value = alunosSelecionados.join(', ');
            }
            
            // Fechar o modal
            fecharModalAlunos();
            
            // Ajustar tamanhos após seleção
            adjustFieldSizes();
        }

        // Registrar ocorrência (Professor)
        async function registrarOcorrenciaProfessor() {
            const professor = document.getElementById('professorNome').value;
            const turma = document.getElementById('professorTurma').value;
            const dataOcorrencia = document.getElementById('dataOcorrencia').value;
            
            // Obter irregularidades selecionadas
            const irregularidades = [];
            document.querySelectorAll('input[name="irregularidades"]:checked').forEach(input => {
                irregularidades.push(input.value);
            });
            
            const descricao = document.getElementById('descricaoOcorrencia').value;
            
            // Validação básica
            if (!professor || !turma || alunosSelecionados.length === 0 || !dataOcorrencia || irregularidades.length === 0 || !descricao) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            // Dados para enviar para a planilha
            const dados = {
                data: dataOcorrencia,
                professor: professor,
                turma: turma,
                alunos: alunosSelecionados.join(', '),
                irregularidades: irregularidades.join(', '),
                descricao: descricao,
                tipoUsuario: 'professor'
            };
            
            try {
                // Enviar para o Google Apps Script
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'cadastrarOcorrencia',
                        spreadsheetId: SPREADSHEET_ID,
                        sheetName: SHEET_NAME,
                        data: dados
                    })
                });
                
                if (response.ok) {
                    // Mostrar mensagem de sucesso
                    document.getElementById('professorSuccessMessage').style.display = 'block';
                    
                    // Limpar formulário após 2 segundos
                    setTimeout(() => {
                        document.getElementById('professorSuccessMessage').style.display = 'none';
                        document.getElementById('professorNome').value = '';
                        document.getElementById('professorTurma').value = '';
                        document.getElementById('dataOcorrencia').value = '';
                        document.querySelectorAll('input[name="irregularidades"]:checked').forEach(input => {
                            input.checked = false;
                        });
                        document.getElementById('descricaoOcorrencia').value = '';
                        
                        // Limpar alunos selecionados
                        alunosSelecionados = [];
                        document.getElementById('selectedStudents').innerHTML = '';
                        document.getElementById('alunoOcorrencia').value = '';
                        
                        // Ajustar tamanhos após limpar
                        adjustFieldSizes();
                    }, 2000);
                } else {
                    alert('Erro ao registrar ocorrência. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro ao registrar ocorrência:', error);
                alert('Erro ao registrar ocorrência. Tente novamente.');
            }
        }

        // Gerar PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Adicionar título
            doc.setFontSize(18);
            doc.text('Registro de Ocorrência', 105, 15, { align: 'center' });
            
            // Adicionar dados do aluno se disponíveis
            if (currentAlunoData) {
                doc.setFontSize(12);
                doc.text(`Aluno: ${currentAlunoData.nome}`, 20, 30);
                doc.text(`Turma: ${currentAlunoData.turma}`, 20, 40);
                doc.text(`RA: ${currentAlunoData.ra || 'Não disponível'}`, 20, 50);
            }
            
            // Adicionar data e hora
            const now = new Date();
            doc.text(`Data do registro: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 20, 60);
            
            // Criar nome do arquivo
            const fileName = `ocorrencia_${now.getTime()}.pdf`;
            
            // Baixar o PDF
            doc.save(fileName);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Definir data atual como padrão para o campo de data da ocorrência (professor)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dataOcorrencia').value = today;
            
            // Fechar modal ao clicar fora dele
            window.onclick = function(event) {
                const modal = document.getElementById('alunosModal');
                if (event.target == modal) {
                    fecharModalAlunos();
                }
            };

            // Melhorar a experiência com campos de data
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                // Adicionar placeholder para navegadores que não suportam type="date"
                if (input.type !== 'date') {
                    input.type = 'text';
                    input.placeholder = 'DD/MM/AAAA';
                }
                
                // Melhorar a experiência de clique
                input.addEventListener('click', function() {
                    this.showPicker ? this.showPicker() : null;
                });
            });
            
            // Configurar observadores e ajustar tamanhos após carregamento
            setTimeout(() => {
                setupFieldObservers();
                adjustFieldSizes();
            }, 500);
        });
    </script>
</body>
</html>
