/**
 * Sistema de Registro de Ocorrências Escolares - Frontend
 * JavaScript com requisições robustas e tratamento de erros
 */

// ===== CONFIGURAÇÕES =====
const CONFIG = {
    // URL do Google Apps Script - SUBSTITUA PELA SUA URL
    API_URL: 'https://script.google.com/macros/s/AKfycbwgqLT6gxXgT1h_IcvzemySgyUCf7g-phOW3WULaWZLEzIMPGnfadbzqZirMsPrdbkq/exec',
    
    // Configurações de retry
    MAX_RETRIES: 3,
    RETRY_DELAY: 1000, // 1 segundo
    REQUEST_TIMEOUT: 30000, // 30 segundos
    
    // Turmas disponíveis
    CLASSES: [
        "6° ANO A MANHA", "6° ANO B MANHA", "6° ANO C MANHA", "6° ANO D MANHA",
        "6° ANO E TARDE", "6° ANO F TARDE",
        "7° ANO A TARDE", "7° ANO B TARDE", "7° ANO C TARDE", "7° ANO D TARDE",
        "7° ANO E TARDE", "7° ANO F TARDE",
        "8° ANO A TARDE", "8° ANO B TARDE", "8° ANO C TARDE", "8° ANO D TARDE",
        "8° ANO E TARDE",
        "9° ANO A TARDE", "9° ANO B TARDE", "9° ANO C TARDE", "9° ANO D TARDE",
        "1ª SERIE A MANHA", "1ª SERIE B MANHA", "1ª SERIE C MANHA", "1ª SERIE D MANHA",
        "1ª SERIE E MANHA", "1ª SERIE F MANHA", "1ª SERIE G TARDE", "1ª SERIE H NOITE",
        "1ª SERIE I NOITE",
        "2ª SERIE A MANHA", "2ª SERIE B MANHA", "2ª SERIE C MANHA", "2ª SERIE D MANHA",
        "2ª SERIE E MANHA", "2ª SERIE F NOITE", "2ª SERIE G NOITE", "2ª SERIE H NOITE",
        "3ª SERIE A MANHA", "3ª SERIE B MANHA", "3ª SERIE C MANHA", "3ª SERIE D NOITE",
        "3ª SERIE E NOITE", "3ª SERIE F NOITE"
    ]
};

// ===== ESTADO GLOBAL =====
let globalState = {
    students: {},
    occurrences: [],
    statistics: {},
    charts: {}
};

// ===== UTILITÁRIOS DE REQUISIÇÃO =====

/**
 * Função utilitária para fazer requisições robustas
 */
async function apiCall(endpoint, options = {}) {
    const {
        method = 'GET',
        data = null,
        retries = CONFIG.MAX_RETRIES,
        timeout = CONFIG.REQUEST_TIMEOUT
    } = options;

    let lastError;
    
    for (let attempt = 1; attempt <= retries; attempt++) {
        try {
            console.log(`Tentativa ${attempt}/${retries} para ${endpoint}`);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            const requestOptions = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                signal: controller.signal
            };
            
            if (data && method !== 'GET') {
                requestOptions.body = JSON.stringify(data);
            }
            
            let url = CONFIG.API_URL;
            if (method === 'GET' && data) {
                const params = new URLSearchParams(data);
                url += '?' + params.toString();
            }
            
            const response = await fetch(url, requestOptions);
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'error') {
                throw new Error(result.message || 'Erro desconhecido do servidor');
            }
            
            console.log(`Sucesso na tentativa ${attempt} para ${endpoint}:`, result);
            return result;
            
        } catch (error) {
            lastError = error;
            console.warn(`Tentativa ${attempt} falhou para ${endpoint}:`, error.message);
            
            if (attempt < retries) {
                const delay = CONFIG.RETRY_DELAY * attempt;
                console.log(`Aguardando ${delay}ms antes da próxima tentativa...`);
                await sleep(delay);
            }
        }
    }
    
    throw new Error(`Falha após ${retries} tentativas: ${lastError.message}`);
}

/**
 * Utilitário para aguardar um tempo
 */
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ===== FUNÇÕES DE API =====

/**
 * Carrega alunos de uma turma
 */
async function loadStudentsByClass(className) {
    try {
        showLoading(true);
        
        if (globalState.students[className]) {
            console.log(`Usando cache para turma: ${className}`);
            return globalState.students[className];
        }
        
        const result = await apiCall('getStudentsByClass', {
            method: 'GET',
            data: { action: 'getStudentsByClass', class: className }
        });
        
        if (result.status === 'success') {
            globalState.students[className] = result.data.students;
            return result.data.students;
        } else {
            throw new Error(result.message || 'Erro ao carregar alunos');
        }
        
    } catch (error) {
        console.error('Erro ao carregar alunos:', error);
        showNotification('Erro ao carregar lista de alunos: ' + error.message, 'error');
        return [];
    } finally {
        showLoading(false);
    }
}

/**
 * Carrega todas as ocorrências
 */
async function loadAllOccurrences() {
    try {
        showLoading(true);
        
        const result = await apiCall('getAllOccurrences', {
            method: 'GET',
            data: { action: 'getAllOccurrences' }
        });
        
        if (result.status === 'success') {
            globalState.occurrences = result.data.occurrences;
            return result.data.occurrences;
        } else {
            throw new Error(result.message || 'Erro ao carregar ocorrências');
        }
        
    } catch (error) {
        console.error('Erro ao carregar ocorrências:', error);
        showNotification('Erro ao carregar registros: ' + error.message, 'error');
        return [];
    } finally {
        showLoading(false);
    }
}

/**
 * Carrega estatísticas do sistema
 */
async function loadStatistics() {
    try {
        const result = await apiCall('getStatistics', {
            method: 'GET',
            data: { action: 'getStatistics' }
        });
        
        if (result.status === 'success') {
            globalState.statistics = result.data;
            return result.data;
        } else {
            throw new Error(result.message || 'Erro ao carregar estatísticas');
        }
        
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
        showNotification('Erro ao carregar estatísticas: ' + error.message, 'error');
        return {};
    }
}

/**
 * Adiciona uma nova ocorrência
 */
async function addOccurrence(occurrenceData) {
    try {
        showLoading(true);
        
        const result = await apiCall('addOccurrence', {
            method: 'POST',
            data: {
                action: 'addOccurrence',
                ...occurrenceData
            }
        });
        
        if (result.status === 'success') {
            showNotification('Ocorrência registrada com sucesso!', 'success');
            
            // Limpar cache para forçar recarregamento
            globalState.occurrences = [];
            
            return result;
        } else {
            throw new Error(result.message || 'Erro ao registrar ocorrência');
        }
        
    } catch (error) {
        console.error('Erro ao adicionar ocorrência:', error);
        showNotification('Erro ao registrar ocorrência: ' + error.message, 'error');
        throw error;
    } finally {
        showLoading(false);
    }
}

/**
 * Testa a conexão com o servidor
 */
async function testConnection() {
    try {
        const result = await apiCall('testConnection', {
            method: 'GET',
            data: { action: 'testConnection' },
            retries: 1,
            timeout: 10000
        });
        
        return result.status === 'success';
    } catch (error) {
        console.error('Teste de conexão falhou:', error);
        return false;
    }
}

// ===== FUNÇÕES DE UI =====

/**
 * Mostra/esconde o overlay de loading
 */
function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        if (show) {
            overlay.classList.add('show');
        } else {
            overlay.classList.remove('show');
        }
    }
}

/**
 * Mostra notificação para o usuário
 */
function showNotification(message, type = 'info', duration = 5000) {
    const container = document.getElementById('notificationContainer');
    if (!container) return;
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icon = type === 'success' ? 'fas fa-check-circle' :
                 type === 'error' ? 'fas fa-exclamation-circle' :
                 type === 'warning' ? 'fas fa-exclamation-triangle' :
                 'fas fa-info-circle';
    
    notification.innerHTML = `
        <i class="${icon}"></i>
        <span>${message}</span>
    `;
    
    container.appendChild(notification);
    
    // Mostrar notificação
    setTimeout(() => notification.classList.add('show'), 100);
    
    // Remover notificação
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, duration);
}

/**
 * Popula o dropdown de turmas
 */
function populateClassDropdowns() {
    const classSelects = document.querySelectorAll('#class, #searchClass');
    
    classSelects.forEach(select => {
        // Limpar opções existentes (exceto a primeira)
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // Adicionar turmas
        CONFIG.CLASSES.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            select.appendChild(option);
        });
    });
}

/**
 * Popula o dropdown de alunos baseado na turma selecionada
 */
async function populateStudentDropdown(className) {
    const studentSelect = document.getElementById('student');
    if (!studentSelect) return;
    
    // Limpar opções existentes
    studentSelect.innerHTML = '<option value="">Carregando alunos...</option>';
    studentSelect.disabled = true;
    
    if (!className) {
        studentSelect.innerHTML = '<option value="">Primeiro selecione uma turma</option>';
        return;
    }
    
    try {
        const students = await loadStudentsByClass(className);
        
        // Limpar e popular
        studentSelect.innerHTML = '<option value="">Selecione um aluno</option>';
        
        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student;
            option.textContent = student;
            studentSelect.appendChild(option);
        });
        
        studentSelect.disabled = false;
        
    } catch (error) {
        studentSelect.innerHTML = '<option value="">Erro ao carregar alunos</option>';
        console.error('Erro ao popular dropdown de alunos:', error);
    }
}

/**
 * Atualiza as estatísticas na dashboard
 */
async function updateDashboardStats() {
    try {
        const stats = await loadStatistics();
        
        // Atualizar valores
        document.getElementById('totalOccurrences').textContent = stats.totalOccurrences || 0;
        document.getElementById('totalClasses').textContent = stats.totalClasses || 0;
        document.getElementById('totalTeachers').textContent = stats.totalTeachers || 0;
        document.getElementById('mostAffectedClass').textContent = stats.mostAffectedClass || 'N/A';
        
        // Atualizar gráfico de irregularidades
        updateIrregularityChart(stats.irregularityCounts || {});
        
        // Atualizar gráficos de relatórios
        updateReportsCharts(stats);
        
    } catch (error) {
        console.error('Erro ao atualizar estatísticas:', error);
    }
}

/**
 * Atualiza o gráfico de irregularidades
 */
function updateIrregularityChart(irregularityCounts) {
    const ctx = document.getElementById('irregularityChart');
    if (!ctx) return;
    
    // Destruir gráfico existente
    if (globalState.charts.irregularity) {
        globalState.charts.irregularity.destroy();
    }
    
    const labels = Object.keys(irregularityCounts);
    const data = Object.values(irregularityCounts);
    
    if (labels.length === 0) {
        // Mostrar mensagem de "sem dados"
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        return;
    }
    
    globalState.charts.irregularity = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

/**
 * Atualiza os gráficos de relatórios
 */
function updateReportsCharts(stats) {
    // Gráfico por turma
    updateClassChart(stats.classCounts || {});
    
    // Gráfico por professor
    updateProfessorChart(stats.professorCounts || {});
}

/**
 * Atualiza o gráfico por turma
 */
function updateClassChart(classCounts) {
    const ctx = document.getElementById('classChart');
    if (!ctx) return;
    
    if (globalState.charts.class) {
        globalState.charts.class.destroy();
    }
    
    const labels = Object.keys(classCounts);
    const data = Object.values(classCounts);
    
    if (labels.length === 0) return;
    
    globalState.charts.class = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ocorrências por Turma',
                data: data,
                backgroundColor: 'rgba(26, 115, 232, 0.8)',
                borderColor: 'rgba(26, 115, 232, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                }
            }
        }
    });
}

/**
 * Atualiza o gráfico por professor
 */
function updateProfessorChart(professorCounts) {
    const ctx = document.getElementById('professorChart');
    if (!ctx) return;
    
    if (globalState.charts.professor) {
        globalState.charts.professor.destroy();
    }
    
    const labels = Object.keys(professorCounts);
    const data = Object.values(professorCounts);
    
    if (labels.length === 0) return;
    
    globalState.charts.professor = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ocorrências por Professor',
                data: data,
                backgroundColor: 'rgba(46, 204, 113, 0.8)',
                borderColor: 'rgba(46, 204, 113, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

/**
 * Carrega e exibe registros na tabela
 */
async function loadAndDisplayRecords(filters = {}) {
    try {
        showLoading(true);
        
        let occurrences = globalState.occurrences;
        
        // Carregar se não estiver em cache
        if (occurrences.length === 0) {
            occurrences = await loadAllOccurrences();
        }
        
        // Aplicar filtros
        let filteredOccurrences = occurrences;
        
        if (filters.class) {
            filteredOccurrences = filteredOccurrences.filter(occ => 
                occ.class && occ.class.toLowerCase().includes(filters.class.toLowerCase())
            );
        }
        
        if (filters.student) {
            filteredOccurrences = filteredOccurrences.filter(occ => 
                occ.student && occ.student.toLowerCase().includes(filters.student.toLowerCase())
            );
        }
        
        if (filters.professor) {
            filteredOccurrences = filteredOccurrences.filter(occ => 
                occ.professor && occ.professor.toLowerCase().includes(filters.professor.toLowerCase())
            );
        }
        
        // Exibir na tabela
        displayRecordsTable(filteredOccurrences);
        
    } catch (error) {
        console.error('Erro ao carregar registros:', error);
        showNotification('Erro ao carregar registros: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

/**
 * Exibe registros na tabela
 */
function displayRecordsTable(occurrences) {
    const tbody = document.getElementById('registrosTableBody');
    if (!tbody) return;
    
    if (occurrences.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">Nenhum registro encontrado</td></tr>';
        return;
    }
    
    tbody.innerHTML = occurrences.map(occ => `
        <tr>
            <td>${occ.date || 'N/A'}</td>
            <td>${occ.professor || 'N/A'}</td>
            <td>${occ.class || 'N/A'}</td>
            <td>${occ.student || 'N/A'}</td>
            <td>${occ.irregularities || 'Nenhuma'}</td>
            <td>
                <button class="btn-action btn-edit" onclick="editRecord('${occ.id}')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn-action btn-delete" onclick="deleteRecord('${occ.id}')">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </td>
        </tr>
    `).join('');
}

/**
 * Gerencia as abas
 */
function setupTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Remover classe active de todos os botões e conteúdos
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Adicionar classe active ao botão clicado e conteúdo correspondente
            button.classList.add('active');
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
                targetContent.classList.add('active');
                
                // Carregar dados específicos da aba
                if (targetTab === 'consulta') {
                    loadAndDisplayRecords();
                } else if (targetTab === 'relatorios') {
                    updateDashboardStats();
                }
            }
        });
    });
}

/**
 * Configura o formulário de ocorrência
 */
function setupOccurrenceForm() {
    const form = document.getElementById('occurrenceForm');
    const classSelect = document.getElementById('class');
    const clearBtn = document.getElementById('clearBtn');
    
    // Listener para mudança de turma
    if (classSelect) {
        classSelect.addEventListener('change', (e) => {
            populateStudentDropdown(e.target.value);
        });
    }
    
    // Listener para envio do formulário
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const data = {};
            
            // Coletar dados básicos
            for (let [key, value] of formData.entries()) {
                if (key !== 'irregularities') {
                    data[key] = value;
                }
            }
            
            // Coletar irregularidades selecionadas
            const irregularities = [];
            const checkboxes = form.querySelectorAll('input[name="irregularities"]:checked');
            checkboxes.forEach(checkbox => {
                irregularities.push(checkbox.value);
            });
            data.irregularities = irregularities.join(', ');
            
            // Validar dados obrigatórios
            if (!data.professor || !data.date || !data.class || !data.student) {
                showNotification('Por favor, preencha todos os campos obrigatórios.', 'warning');
                return;
            }
            
            try {
                await addOccurrence(data);
                form.reset();
                
                // Resetar dropdown de alunos
                const studentSelect = document.getElementById('student');
                if (studentSelect) {
                    studentSelect.innerHTML = '<option value="">Primeiro selecione uma turma</option>';
                    studentSelect.disabled = true;
                }
                
                // Atualizar estatísticas
                updateDashboardStats();
                
            } catch (error) {
                // Erro já tratado na função addOccurrence
            }
        });
    }
    
    // Listener para botão de limpar
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            form.reset();
            const studentSelect = document.getElementById('student');
            if (studentSelect) {
                studentSelect.innerHTML = '<option value="">Primeiro selecione uma turma</option>';
                studentSelect.disabled = true;
            }
        });
    }
}

/**
 * Configura os filtros de busca
 */
function setupSearchFilters() {
    const searchBtn = document.getElementById('searchBtn');
    
    if (searchBtn) {
        searchBtn.addEventListener('click', () => {
            const filters = {
                class: document.getElementById('searchClass').value,
                student: document.getElementById('searchStudent').value,
                professor: document.getElementById('searchProfessor').value
            };
            
            loadAndDisplayRecords(filters);
        });
    }
    
    // Busca em tempo real
    const searchInputs = document.querySelectorAll('#searchStudent, #searchProfessor');
    searchInputs.forEach(input => {
        let timeout;
        input.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const filters = {
                    class: document.getElementById('searchClass').value,
                    student: document.getElementById('searchStudent').value,
                    professor: document.getElementById('searchProfessor').value
                };
                loadAndDisplayRecords(filters);
            }, 500);
        });
    });
    
    // Filtro por turma
    const searchClass = document.getElementById('searchClass');
    if (searchClass) {
        searchClass.addEventListener('change', () => {
            const filters = {
                class: searchClass.value,
                student: document.getElementById('searchStudent').value,
                professor: document.getElementById('searchProfessor').value
            };
            loadAndDisplayRecords(filters);
        });
    }
}

/**
 * Configura botões de ação
 */
function setupActionButtons() {
    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
            // Limpar cache
            globalState.students = {};
            globalState.occurrences = [];
            globalState.statistics = {};
            
            // Recarregar dados
            await updateDashboardStats();
            
            // Se estiver na aba de consulta, recarregar registros
            const consultaTab = document.getElementById('consulta');
            if (consultaTab && consultaTab.classList.contains('active')) {
                await loadAndDisplayRecords();
            }
            
            showNotification('Dados atualizados com sucesso!', 'success');
        });
    }
    
    if (exportBtn) {
        exportBtn.addEventListener('click', () => {
            exportToCSV();
        });
    }
}

/**
 * Exporta dados para CSV
 */
function exportToCSV() {
    if (globalState.occurrences.length === 0) {
        showNotification('Nenhum dado para exportar.', 'warning');
        return;
    }
    
    const headers = ['Data', 'Professor', 'Turma', 'Aluno', 'Irregularidades', 'Descrição'];
    const csvContent = [
        headers.join(','),
        ...globalState.occurrences.map(occ => [
            occ.date || '',
            `"${occ.professor || ''}"`,
            `"${occ.class || ''}"`,
            `"${occ.student || ''}"`,
            `"${occ.irregularities || ''}"`,
            `"${(occ.description || '').replace(/"/g, '""')}"`
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `ocorrencias_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Relatório exportado com sucesso!', 'success');
}

/**
 * Editar registro (placeholder)
 */
function editRecord(id) {
    showNotification('Funcionalidade de edição em desenvolvimento.', 'info');
}

/**
 * Excluir registro (placeholder)
 */
function deleteRecord(id) {
    if (confirm('Tem certeza que deseja excluir este registro?')) {
        showNotification('Funcionalidade de exclusão em desenvolvimento.', 'info');
    }
}

/**
 * Configura a data padrão como hoje
 */
function setupDefaultDate() {
    const dateInput = document.getElementById('date');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
}

/**
 * Verifica a conexão com o servidor
 */
async function checkConnection() {
    const isConnected = await testConnection();
    
    if (!isConnected) {
        showNotification(
            'Não foi possível conectar ao servidor. Verifique a URL da API nas configurações.',
            'error',
            10000
        );
    }
    
    return isConnected;
}

// ===== INICIALIZAÇÃO =====

/**
 * Inicializa a aplicação
 */
async function initializeApp() {
    try {
        console.log('Inicializando aplicação...');
        
        // Verificar conexão
        const connected = await checkConnection();
        
        if (connected) {
            // Configurar componentes
            populateClassDropdowns();
            setupTabs();
            setupOccurrenceForm();
            setupSearchFilters();
            setupActionButtons();
            setupDefaultDate();
            
            // Carregar dados iniciais
            await updateDashboardStats();
            
            console.log('Aplicação inicializada com sucesso!');
            showNotification('Sistema carregado com sucesso!', 'success');
        } else {
            console.warn('Aplicação inicializada em modo offline');
        }
        
    } catch (error) {
        console.error('Erro ao inicializar aplicação:', error);
        showNotification('Erro ao inicializar sistema: ' + error.message, 'error');
    }
}

// ===== EVENT LISTENERS =====

// Inicializar quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', initializeApp);

// Tratar erros globais
window.addEventListener('error', (event) => {
    console.error('Erro global capturado:', event.error);
    showNotification('Ocorreu um erro inesperado. Tente recarregar a página.', 'error');
});

// Tratar promessas rejeitadas
window.addEventListener('unhandledrejection', (event) => {
    console.error('Promise rejeitada:', event.reason);
    showNotification('Erro de comunicação com o servidor.', 'error');
});

// Expor funções globais necessárias
window.editRecord = editRecord;
window.deleteRecord = deleteRecord;

