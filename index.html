<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorrências - 2025 (Corrigido)</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,#9fe7ff 0%, #b9f7c9 60%, #baf3ff 100%);color:#111;padding:18px}
    .app{max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:10px;background:linear-gradient(90deg,#0b3a64,#13608d);color:#fff}
    .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    label{display:block;margin-bottom:6px;font-size:13px;color:#333}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e2e6ea;font-weight:600}
    textarea{min-height:110px;resize:vertical}
    .flex{display:flex;gap:12px}
    .col{display:flex;flex-direction:column;gap:10px}
    button{cursor:pointer;border:none;padding:10px 12px;border-radius:8px;font-weight:800}
    .btn-primary{background:#1e3c72;color:#fff}
    .btn-danger{background:#e94b4b;color:#fff}
    .btn-success{background:#4caf50;color:#fff}
    .muted{color:#666}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .historyItem{background:#f7fafc;border-left:5px solid #cbd5e1;padding:12px;border-radius:8px}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
    .modal{width:94%;max-width:760px;background:#fff;color:#111;border-radius:10px;padding:14px}
    .pill{background:#2a5298;color:#fff;padding:6px 10px;border-radius:999px;display:inline-block;margin-right:6px}
    @media(max-width:900px){.flex{flex-direction:column}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1 style="font-size:18px">2025 — Cadastro de Ocorrências (Corrigido)</h1>
      <div id="userDisplay" class="muted">Não autenticado</div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card">
      <div style="max-width:420px;margin:0 auto">
        <div class="muted" style="margin-bottom:8px">Login</div>
        <label for="inputEmail">E-mail</label>
        <input id="inputEmail" type="email" />
        <label for="inputPassword" style="margin-top:8px">Senha</label>
        <input id="inputPassword" type="password" />
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn-primary" onclick="handleLogin()">Entrar</button>
          <button class="btn-danger" onclick="fillDemoCredentials()">Demo</button>
        </div>
      </div>
    </div>

    <!-- GESTAO -->
    <div id="mainAppGestao" style="display:none;">
      <div class="card">
        <div class="muted">CADASTRO — GESTÃO</div>
        <div class="flex" style="margin-top:10px">
          <div class="col" style="flex:1">
            <label>Turma</label>
            <select id="turma_gestao"><option value="">-- carregando --</option></select>
            <label style="margin-top:8px">Aluno</label>
            <select id="aluno_gestao"><option value="">-- selecione turma --</option></select>
            <div class="flex" style="margin-top:8px">
              <div style="flex:1">
                <label>RA</label>
                <input id="ra_gestao" readonly />
              </div>
              <div style="flex:1">
                <label>Professor</label>
                <input id="professor_gestao" />
              </div>
            </div>
            <label style="margin-top:8px">Disciplina</label>
            <input id="disciplina_gestao" />
            <div class="flex" style="margin-top:8px;align-items:flex-end">
              <div style="flex:1">
                <label>Classificação</label>
                <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                  <option value="">Selecione</option>
                  <option value="OCORRÊNCIA">OCORRÊNCIA</option>
                  <option value="SUSPENSÃO">SUSPENSÃO</option>
                </select>
              </div>
              <div style="flex:1">
                <label>Data</label>
                <input id="data_gestao" type="date" />
              </div>
            </div>
            <div id="suspensionRow_gestao" style="display:none;margin-top:8px">
              <label>Data de retorno</label>
              <input id="dataRetorno_gestao" type="date" />
            </div>
            <label style="margin-top:8px">Descrição</label>
            <textarea id="descricao_gestao" placeholder="Descrição detalhada"></textarea>

            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gestão)</button>
              <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
            </div>
            <div id="successGestao" style="display:none;margin-top:10px;padding:10px;border-radius:8px;background:#e6ffed;color:#064e2b;font-weight:800">Ocorrência registrada com sucesso!</div>
          </div>
          <div style="flex:1">
            <div class="muted">HISTÓRICO DE OCORRÊNCIAS - GESTÃO</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
            </div>
            <div id="historyListGestao" class="historyList" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;">
      <div class="card">
        <div class="muted">REGISTRO — PROFESSOR</div>
        <div class="flex" style="margin-top:10px">
          <div class="col" style="flex:1">
            <label>Professor</label>
            <select id="professor_select"></select>
            <label style="margin-top:8px">Turma</label>
            <select id="turma_select" onchange="onTurmaChange()"></select>

            <label style="margin-top:8px">Alunos (clique para selecionar)</label>
            <input id="alunos_selected_input" readonly placeholder="Clique para selecionar" onclick="openStudentsModal()" />
            <div id="selectedPills" style="margin-top:8px"></div>

            <div style="display:flex;gap:8px;margin-top:8px;align-items:flex-end">
              <div style="flex:1">
                <label>Data</label>
                <input id="data_prof" type="date" />
              </div>
            </div>

            <label style="margin-top:8px">Irregularidades</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <label style="background:#efefef;color:#111;padding:6px 10px;border-radius:999px"><input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina</label>
              <label style="background:#efefef;color:#111;padding:6px 10px;border-radius:999px"><input type="checkbox" name="irreg" value="Agressão"> Agressão</label>
              <label style="background:#efefef;color:#111;padding:6px 10px;border-radius:999px"><input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular</label>
              <label style="background:#efefef;color:#111;padding:6px 10px;border-radius:999px"><input type="checkbox" name="irreg" value="Falta de material"> Falta de material</label>
            </div>

            <label style="margin-top:8px">Descrição</label>
            <textarea id="descricao_prof" placeholder="Descreva a ocorrência..."></textarea>

            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
              <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
            </div>
            <div id="successProfessor" style="display:none;margin-top:10px;padding:10px;border-radius:8px;background:#e6ffed;color:#064e2b;font-weight:800">Ocorrência registrada com sucesso!</div>
          </div>

          <div style="flex:1">
            <div class="muted">HISTÓRICO DE OCORRÊNCIAS - PROFESSOR</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
            </div>
            <div id="historyListProfessor" class="historyList" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong>Selecionar alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;cursor:pointer">✕</button>
        </header>
        <div>
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px" oninput="filterStudentList()">
          <div id="studentList" style="max-height:340px;overflow:auto"></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>
  /*******************************
   * CONFIGURAÇÃO: URL do seu Web App (Apps Script)
   * Troque abaixo pela URL do seu deploy (doGet / doPost)
   *******************************/
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYI7oGYslwekOSH88reii6xhlJ12dpshNJk0miuQoRJm0tiu5GxtgmR9w345Ucgl2I/exec';

  // constante de folhas (mantidas apenas para referência local)
  const SHEET_GERAL = 'BANCODEDADOSGERAL';
  const SHEET_PRO = 'OCORRENCIASDOSPROFESSORES';
  const SHEET_GEST = 'BANCODEALUNOS';

  // estado local
  let alunosDaTurmaAtual = [];
  let alunosSelecionados = [];
  let professores = [];
  let turmas = [];
  let currentUserRole = null;

  document.addEventListener('DOMContentLoaded', () => {
    // set datas default
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data_prof').value = hoje;
    document.getElementById('data_gestao').value = hoje;

    // carregar lists (chamado após login também)
  });

  function fillDemoCredentials(){
    document.getElementById('inputEmail').value = 'professor@escola.com';
    document.getElementById('inputPassword').value = 'prof123';
  }

  function handleLogin(){
    const email = document.getElementById('inputEmail').value.trim();
    const pass = document.getElementById('inputPassword').value.trim();
    if(!email || !pass){ alert('Informe e-mail e senha.'); return; }

    // demo simples
    if(email.toLowerCase() === 'gestao@escola.com' && pass === 'gestao123'){ showAppAs('gestao', email); return; }
    if(email.toLowerCase() === 'professor@escola.com' && pass === 'prof123'){ showAppAs('professor', email); return; }
    alert('E-mail ou senha incorretos.');
  }

  function showAppAs(role, email){
    currentUserRole = role;
    document.getElementById('loginScreen').style.display = 'none';
    if(role === 'gestao'){
      document.getElementById('mainAppGestao').style.display = 'block';
      document.getElementById('mainAppProfessor').style.display = 'none';
      carregarProfessoresETurmas();
      carregarHistoricoGestao();
    } else {
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'block';
      carregarProfessoresETurmas();
      carregarHistoricoProfessor();
    }
    document.getElementById('userDisplay').textContent = email + (role === 'gestao' ? ' (Gestão)' : ' (Professor)');
  }

  /*******************************
   * GET professores & turmas
   *******************************/
  async function carregarProfessoresETurmas(){
    try{
      // teachers
      const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers`);
      if(!r1.ok) throw new Error('teachers fetch failed: ' + r1.status);
      const j1 = await r1.json();
      professores = (j1 && j1.status === 'success' && Array.isArray(j1.teachers)) ? j1.teachers : [];

      // classes
      const r2 = await fetch(`${SCRIPT_URL}?endpoint=classes`);
      if(!r2.ok) throw new Error('classes fetch failed: ' + r2.status);
      const j2 = await r2.json();
      turmas = (j2 && j2.status === 'success' && Array.isArray(j2.classes)) ? j2.classes : [];

    } catch(err){
      console.error('Erro carregarProfessoresETurmas:', err);
      // fallback: usar as listas hardcoded do arquivo original (se desejar, cole aqui)
      professores = [];
      turmas = [];
    }

    // popular selects
    const profSel = document.getElementById('professor_select');
    const progSelGest = document.getElementById('professor_gestao');

    if(profSel){
      profSel.innerHTML = '<option value="">-- selecione --</option>' + professores.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
    }
    if(progSelGest){
      progSelGest.innerHTML = '';
    }

    ['turma_select','turma_gestao'].forEach(id => {
      const sel = document.getElementById(id);
      if(!sel) return;
      sel.innerHTML = '<option value="">-- selecione --</option>' + turmas.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    });
  }

  /*******************************
   * GET students by class
   *******************************/
  async function carregarAlunosPorTurma(turma){
    alunosDaTurmaAtual = [];
    if(!turma) return alunosDaTurmaAtual;
    try{
      const resp = await fetch(`${SCRIPT_URL}?endpoint=students&turma=${encodeURIComponent(turma)}`);
      if(!resp.ok){
        const t = await resp.text();
        console.warn('carregarAlunosPorTurma não OK:', resp.status, t);
        return alunosDaTurmaAtual;
      }
      const json = await resp.json();
      const raw = json.students || json.data || json.studentsList || [];
      if(!Array.isArray(raw)) return alunosDaTurmaAtual;
      alunosDaTurmaAtual = raw.map(item => {
        if(typeof item === 'string') return { nome: item, ra: '' };
        if(Array.isArray(item)) return { nome: item[0]||'', ra: item[1]||'' };
        if(item && item.nome) return { nome: item.nome, ra: item.ra || '' };
        return null;
      }).filter(x => x && x.nome);
    } catch(err){
      console.error('Erro carregarAlunosPorTurma:', err);
    }
    return alunosDaTurmaAtual;
  }

  async function onTurmaChange(){
    const turma = document.getElementById('turma_select').value;
    if(!turma){ alunosDaTurmaAtual = []; renderStudentList([]); return; }
    await carregarAlunosPorTurma(turma);
    renderStudentList(alunosDaTurmaAtual);
  }

  async function onTurmaChangeGestao(){
    const turma = document.getElementById('turma_gestao').value;
    const sel = document.getElementById('aluno_gestao');
    sel.innerHTML = '<option>Carregando...</option>';
    if(!turma){ sel.innerHTML = '<option value="">-- selecione turma --</option>'; return; }
    await carregarAlunosPorTurma(turma);
    sel.innerHTML = '<option value="">-- selecione --</option>' + alunosDaTurmaAtual.map(a => `<option value="${escapeHtml(a.nome)}">${escapeHtml(a.nome)}</option>`).join('');
    document.getElementById('ra_gestao').value = '';
  }

  function onAlunoSelectGestao(){
    const nome = document.getElementById('aluno_gestao').value;
    const match = alunosDaTurmaAtual.find(it => it.nome === nome);
    if(match) document.getElementById('ra_gestao').value = match.ra || '';
    else document.getElementById('ra_gestao').value = '';
  }

  /*******************************
   * modal / seleção múltipla (professor)
   *******************************/
  function renderStudentList(list){
    const container = document.getElementById('studentList');
    container.innerHTML = '';
    list.forEach(item => {
      const nome = item.nome || String(item);
      const row = document.createElement('div');
      row.style.display='flex';row.style.justifyContent='space-between';row.style.alignItems='center';row.style.padding='8px';row.style.borderBottom='1px solid #eee';
      const lbl = document.createElement('div'); lbl.textContent = nome;
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value = nome; cb.checked = alunosSelecionados.includes(nome);
      cb.onchange = (e) => { if(e.target.checked){ if(!alunosSelecionados.includes(nome)) alunosSelecionados.push(nome); } else alunosSelecionados = alunosSelecionados.filter(x=>x!==nome); };
      row.appendChild(lbl); row.appendChild(cb); container.appendChild(row);
    });
  }

  function openStudentsModal(){
    if(!alunosDaTurmaAtual || alunosDaTurmaAtual.length === 0){ alert('Nenhum aluno encontrado para a turma selecionada.'); return; }
    document.getElementById('modalRoot').style.display = 'flex';
    renderStudentList(alunosDaTurmaAtual);
    document.getElementById('studentSearch').value = '';
  }

  function closeStudentsModal(){ document.getElementById('modalRoot').style.display = 'none'; }
  function filterStudentList(){ const q = document.getElementById('studentSearch').value.toLowerCase(); renderStudentList(alunosDaTurmaAtual.filter(s => (s.nome||'').toLowerCase().includes(q))); }
  function confirmStudents(){ document.getElementById('alunos_selected_input').value = alunosSelecionados.join(', '); const pills = document.getElementById('selectedPills'); pills.innerHTML = ''; alunosSelecionados.forEach(a => { const el = document.createElement('div'); el.className = 'pill'; el.textContent = a; pills.appendChild(el); }); closeStudentsModal(); }

  function toggleSuspension(area){ if(area === 'gestao'){ const val = document.getElementById('classificacao_gestao').value; document.getElementById('suspensionRow_gestao').style.display = (val === 'SUSPENSÃO') ? 'block' : 'none'; } }

  /*******************************
   * POST cadastrar ocorrência (gestao)
   * -> enviar payload com os campos que o backend espera: professor, turma, aluno, irregularidades, descricao
   *******************************/
  async function cadastrarOcorrenciaGestao(){
    const aluno = document.getElementById('aluno_gestao').value.trim();
    const serie = document.getElementById('turma_gestao').value.trim();
    const professor = document.getElementById('professor_gestao').value.trim();
    const disciplina = document.getElementById('disciplina_gestao').value.trim();
    const classificacao = document.getElementById('classificacao_gestao').value;
    const descricao = document.getElementById('descricao_gestao').value.trim();
    const dataRetorno = document.getElementById('dataRetorno_gestao').value || null;
    const date = document.getElementById('data_gestao').value || new Date().toISOString().split('T')[0];

    if(!aluno || !serie || !professor || !disciplina || !classificacao || !descricao){ alert('Preencha todos os campos obrigatórios.'); return; }
    if(classificacao === 'SUSPENSÃO' && !dataRetorno){ alert('Informe data de retorno para suspensão.'); return; }

    const payload = {
      professor: professor,
      turma: serie,
      aluno: aluno,
      irregularidades: classificacao + (dataRetorno ? (' - retorno: ' + dataRetorno) : ''),
      descricao: descricao,
      date: date // opcional, backend poderá usar
    };

    try{
      const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if(!resp.ok){ const text = await resp.text(); console.error('Resposta não OK do servidor (gestao):', resp.status, text); alert('Erro ao comunicar com o servidor. Veja console (status '+resp.status+').'); return; }
      const j = await resp.json();
      if(j && j.status === 'success'){
        document.getElementById('successGestao').style.display = 'block';
        setTimeout(()=>document.getElementById('successGestao').style.display = 'none',2200);
        // limpar campos
        document.getElementById('aluno_gestao').value = '';
        document.getElementById('turma_gestao').value = '';
        document.getElementById('ra_gestao').value = '';
        document.getElementById('professor_gestao').value = '';
        document.getElementById('disciplina_gestao').value = '';
        document.getElementById('classificacao_gestao').value = '';
        document.getElementById('descricao_gestao').value = '';
        document.getElementById('suspensionRow_gestao').style.display = 'none';
        carregarHistoricoGestao();
      } else { console.error('Resposta JSON inesperada (gestao):', j); alert('Erro ao registrar: resposta inesperada (ver console).'); }

    } catch(err){ console.error('Erro POST ocorrencia (gestao):', err); alert('Erro ao comunicar com o servidor (ver console). Possíveis causas: URL errada, Web App não implantado com permissão "Anyone", ou doPost não implementado no backend.'); }
  }

  /*******************************
   * POST registrar ocorrência (professor)
   *******************************/
  async function registrarOcorrenciaProfessor(){
    const professor = document.getElementById('professor_select').value;
    const turma = document.getElementById('turma_select').value;
    const dataOc = document.getElementById('data_prof').value;
    const descricao = document.getElementById('descricao_prof').value.trim();
    if(!professor || !turma || !dataOc || alunosSelecionados.length === 0){ alert('Preencha todos os campos obrigatórios e selecione ao menos um aluno.'); return; }
    const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value);

    const payload = {
      professor: professor,
      turma: turma,
      aluno: alunosSelecionados.join(', '),
      irregularidades: irregs.join(', '),
      descricao: descricao,
      date: dataOc
    };

    try{
      const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!resp.ok){ const text = await resp.text(); console.error('Resposta não OK do servidor (professor):', resp.status, text); alert('Erro ao comunicar com o servidor. Veja console (status '+resp.status+').'); return; }
      const j = await resp.json();
      if(j && j.status === 'success'){
        document.getElementById('successProfessor').style.display = 'block';
        setTimeout(()=>document.getElementById('successProfessor').style.display = 'none',2200);
        clearProfessorForm();
        carregarHistoricoProfessor();
      } else { console.error('Resposta JSON inesperada (professor):', j); alert('Erro ao registrar: resposta inesperada (ver console).'); }
    }catch(err){ console.error('Erro POST ocorrencia (professor):', err); alert('Erro ao comunicar com o servidor (ver console). Verifique o Web App.'); }
  }

  function clearProfessorForm(){
    document.getElementById('professor_select').value='';
    document.getElementById('turma_select').value='';
    document.getElementById('alunos_selected_input').value='';
    document.getElementById('selectedPills').innerHTML='';
    document.getElementById('descricao_prof').value='';
    alunosSelecionados = [];
    Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb=>cb.checked=false);
    document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
  }

  /*******************************
   * Histórico: GET occurrences
   *******************************/
  async function carregarHistoricoGestao(){
    const container = document.getElementById('historyListGestao');
    container.innerHTML = '<div class="muted">Carregando histórico...</div>';
    try{
      const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences`);
      if(!resp.ok){ const text = await resp.text(); console.error('carregarHistoricoGestao não OK', resp.status, text); container.innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>'; return; }
      const json = await resp.json();
      const ocorrs = json.occurrences || json.data || json.rows || [];
      container.innerHTML = '';
      if(!ocorrs || ocorrs.length === 0){ container.innerHTML = '<div class="muted">Nenhuma ocorrência encontrada.</div>'; return; }

      // As ocorrências podem ser objetos com chaves vindas do cabeçalho da planilha
      ocorrs.slice().reverse().forEach(r => {
        const id = r.ID || r.Id || r.id || r['ID'] || '';
        const date = formatPossibleDate(r.Data || r.Date || r.data || r['Data']);
        const prof = r.Professor || r.professor || r['Professor'] || '';
        const turma = r.Turma || r.turma || r['Turma'] || '';
        const aluno = r.Aluno || r.aluno || r['Aluno'] || r['Aluno(s)'] || '';
        const irreg = r.Irregularidades || r.irregularidades || r['Irregularidades'] || r['Irregularidade'] || '';
        const desc = r.Descrição || r.descricao || r['Descrição'] || r['Descricao'] || '';

        const div = document.createElement('div'); div.className = 'historyItem';
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(date)}</strong> — <span class='muted'>${escapeHtml(prof)}</span></div></div>`;
        const body = document.createElement('div'); body.style.marginTop='8px';
        body.innerHTML = `<strong>Aluno(s):</strong> ${escapeHtml(aluno)||'N/A'}<br/><strong>Turma:</strong> ${escapeHtml(turma)||'N/A'}<br/><strong>Irregularidades:</strong> ${escapeHtml(irreg)||'N/A'}<br/><em>${escapeHtml(desc)||''}</em>`;
        div.appendChild(body);

        container.appendChild(div);
      });

    } catch(err){ console.error('Erro carregarHistoricoGestao:', err); container.innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>'; }
  }

  async function carregarHistoricoProfessor(){
    const container = document.getElementById('historyListProfessor');
    container.innerHTML = '<div class="muted">Carregando histórico...</div>';
    try{
      const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences`);
      if(!resp.ok){ const text = await resp.text(); console.error('carregarHistoricoProfessor não OK', resp.status, text); container.innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>'; return; }
      const json = await resp.json();
      const ocorrs = json.occurrences || json.data || [];
      container.innerHTML = '';
      if(!ocorrs || ocorrs.length === 0){ container.innerHTML = '<div class="muted">Nenhuma ocorrência encontrada.</div>'; return; }

      ocorrs.slice().reverse().forEach(r => {
        const date = formatPossibleDate(r.Data || r.Date || r.data || r['Data']);
        const prof = r.Professor || r.professor || r['Professor'] || '';
        const turma = r.Turma || r.turma || r['Turma'] || '';
        const aluno = r.Aluno || r.aluno || r['Aluno'] || '';
        const irreg = r.Irregularidades || r.irregularidades || '';
        const desc = r.Descrição || r.descricao || '';
        const div = document.createElement('div'); div.className='historyItem';
        div.innerHTML = `<div><strong>${escapeHtml(date)}</strong> — <span class='muted'>${escapeHtml(prof)}</span></div><div style='margin-top:8px'><strong>Aluno(s):</strong> ${escapeHtml(aluno)||'N/A'}<br/><strong>Turma:</strong> ${escapeHtml(turma)||'N/A'}<br/><strong>Irregularidades:</strong> ${escapeHtml(irreg)||'N/A'}<br/><em>${escapeHtml(desc)||''}</em></div>`;
        container.appendChild(div);
      });

    }catch(err){ console.error('Erro carregarHistoricoProfessor:', err); container.innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>'; }
  }

  /*******************************
   * util
   *******************************/
  function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
  function formatPossibleDate(v){ if(!v) return ''; try{ const d = new Date(v); if(!isNaN(d)) return d.toLocaleDateString(); return String(v); }catch(e){return String(v);} }

  function generatePDFLocal(){ try{ const docContent = [];
    const aluno = document.getElementById('aluno_gestao').value || '';
    const turma = document.getElementById('turma_gestao').value || '';
    const prof = document.getElementById('professor_gestao').value || '';
    const desc = document.getElementById('descricao_gestao').value || '';
    let txt = 'Registro de Ocorrência\n'; txt += 'Aluno: ' + aluno + '\n'; txt += 'Turma: ' + turma + '\n'; txt += 'Professor: ' + prof + '\n\n'; txt += desc || 'Sem descrição';
    // tenta usar window.print como fallback simples (não gera PDF no client sem lib)
    const w = window.open('about:blank','_blank'); w.document.write('<pre>'+escapeHtml(txt)+'</pre>'); w.document.close();
  }catch(err){ console.error('Erro gerar PDF local:', err); alert('Erro ao gerar PDF local (ver console).'); } }

  // util: expose carregarTurmas for initial testing
  window.carregarProfessoresETurmas = carregarProfessoresETurmas;
  window.onTurmaChange = onTurmaChange;
  window.onTurmaChangeGestao = onTurmaChangeGestao;
  window.onAlunoSelectGestao = onAlunoSelectGestao;
  window.carregarHistoricoGestao = carregarHistoricoGestao;
  window.carregarHistoricoProfessor = carregarHistoricoProfessor;

  </script>
</body>
</html>
